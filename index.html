<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรายงาน NCR - สถิติการส่งออกทุเรียน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Sarabun', sans-serif; } </style>
</head>
<body class="bg-gray-100 p-4">

<div id="app" class="max-w-7xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
    <div class="bg-green-800 text-white p-6 text-center relative overflow-hidden">
        <h1 class="text-2xl md:text-3xl font-bold">สถิติการส่งออกทุเรียนไปจีน ประจำวันที่ {{ currentDate }}</h1>
        <p class="text-sm mt-2 opacity-90">โดย สำนักควบคุมพืชและวัสดุการเกษตร กรมวิชาการเกษตร</p>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-sm text-center border-collapse border border-gray-300">
            <thead class="bg-green-700 text-white">
                <tr>
                    <th rowspan="2" class="border border-green-600 p-2">ด่านส่งออก</th>
                    <th rowspan="2" class="border border-green-600 p-2">ด่านนำเข้า</th>
                    <th colspan="3" class="border border-green-600 p-1 bg-yellow-600">ภาคตะวันออก</th>
                    <th colspan="3" class="border border-green-600 p-1 bg-green-900">ภาคใต้</th>
                    <th colspan="3" class="border border-green-600 p-1 bg-gray-600">ภาคอื่นๆ</th>
                </tr>
                <tr>
                    <th class="border border-green-600 p-1 bg-yellow-700 text-xs">จำนวน</th>
                    <th class="border border-green-600 p-1 bg-yellow-700 text-xs">ปริมาณ</th>
                    <th class="border border-green-600 p-1 bg-yellow-700 text-xs">มูลค่า</th>
                    <th class="border border-green-600 p-1 bg-green-800 text-xs">จำนวน</th>
                    <th class="border border-green-600 p-1 bg-green-800 text-xs">ปริมาณ</th>
                    <th class="border border-green-600 p-1 bg-green-800 text-xs">มูลค่า</th>
                    <th class="border border-green-600 p-1 bg-gray-500 text-xs">จำนวน</th>
                    <th class="border border-green-600 p-1 bg-gray-500 text-xs">ปริมาณ</th>
                    <th class="border border-green-600 p-1 bg-gray-500 text-xs">มูลค่า</th>
                </tr>
            </thead>
            <tbody>
                <template v-for="(group, index) in groupedData" :key="index">
                    <tr v-for="(route, rIndex) in group.routes" :key="rIndex" class="hover:bg-gray-50">
                        <td v-if="rIndex === 0" :rowspan="group.routes.length" class="border border-gray-300 p-2 font-bold bg-yellow-100 text-left align-top">
                            {{ group.checkpoint }}
                        </td>
                        
                        <td class="border border-gray-300 p-2 text-left">{{ route.destination }}</td>

                        <td class="border border-gray-300 p-2">{{ formatNum(route.EAST.quantity) }}</td>
                        <td class="border border-gray-300 p-2">{{ formatNum(route.EAST.volume) }}</td>
                        <td class="border border-gray-300 p-2">{{ formatNum(route.EAST.value) }}</td>

                        <td class="border border-gray-300 p-2">{{ formatNum(route.SOUTH.quantity) }}</td>
                        <td class="border border-gray-300 p-2">{{ formatNum(route.SOUTH.volume) }}</td>
                        <td class="border border-gray-300 p-2">{{ formatNum(route.SOUTH.value) }}</td>

                        <td class="border border-gray-300 p-2">{{ formatNum(route.OTHER.quantity) }}</td>
                        <td class="border border-gray-300 p-2">{{ formatNum(route.OTHER.volume) }}</td>
                        <td class="border border-gray-300 p-2">{{ formatNum(route.OTHER.value) }}</td>
                    </tr>
                </template>
            </tbody>
            <tfoot class="bg-green-800 text-white font-bold">
                <tr>
                    <td colspan="2" class="p-3 text-right">รวมทั้งสิ้น</td>
                    <td>{{ formatNum(grandTotal.EAST.quantity) }}</td>
                    <td>{{ formatNum(grandTotal.EAST.volume) }}</td>
                    <td>{{ formatNum(grandTotal.EAST.value) }}</td>
                    <td>{{ formatNum(grandTotal.SOUTH.quantity) }}</td>
                    <td>{{ formatNum(grandTotal.SOUTH.volume) }}</td>
                    <td>{{ formatNum(grandTotal.SOUTH.value) }}</td>
                    <td>{{ formatNum(grandTotal.OTHER.quantity) }}</td>
                    <td>{{ formatNum(grandTotal.OTHER.volume) }}</td>
                    <td>{{ formatNum(grandTotal.OTHER.value) }}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, computed } = Vue
    const { createClient } = supabase

    // --- แก้ไขค่าตรงนี้ (เอาจาก Supabase มาใส่) ---
    const SUPABASE_URL = 'https://mosuesqmaizjlzqgdwpz.supabase.co' 
    const SUPABASE_KEY = 'sb_publishable_7KY0PIfsjolYgzrPMCfL9w_IaqnVv4h'
    // ------------------------------------------

    createApp({
        setup() {
            const rawData = ref([])
            const currentDate = ref(new Date().toLocaleDateString('th-TH'))
            const sb = createClient(SUPABASE_URL, SUPABASE_KEY)

            // ดึงข้อมูลจาก Supabase
            const fetchData = async () => {
                const { data, error } = await sb.from('exports').select('*')
                if (error) console.error('Error:', error)
                else rawData.value = data
            }

            // จัดกลุ่มข้อมูล (Logic ยากสุด แต่ผมเขียนให้แล้ว)
            const groupedData = computed(() => {
                const groups = {}
                rawData.value.forEach(item => {
                    if (!groups[item.checkpoint_name]) {
                        groups[item.checkpoint_name] = {}
                    }
                    if (!groups[item.checkpoint_name][item.destination]) {
                        groups[item.checkpoint_name][item.destination] = { EAST: {quantity:0, volume:0, value:0}, SOUTH: {quantity:0, volume:0, value:0}, OTHER: {quantity:0, volume:0, value:0} }
                    }
                    // บวกเลขเข้ากลุ่ม
                    const target = groups[item.checkpoint_name][item.destination][item.region]
                    if (target) {
                        target.quantity += item.quantity || 0
                        target.volume += item.volume || 0
                        target.value += item.value || 0
                    }
                })

                // แปลงเป็น Array เพื่อวนลูปแสดงผล
                return Object.keys(groups).map(cp => ({
                    checkpoint: cp,
                    routes: Object.keys(groups[cp]).map(dest => ({
                        destination: dest,
                        ...groups[cp][dest]
                    }))
                }))
            })

            // คำนวณยอดรวมทั้งหมด
            const grandTotal = computed(() => {
                let total = { EAST: {quantity:0, volume:0, value:0}, SOUTH: {quantity:0, volume:0, value:0}, OTHER: {quantity:0, volume:0, value:0} }
                rawData.value.forEach(item => {
                    if(total[item.region]) {
                        total[item.region].quantity += item.quantity || 0
                        total[item.region].volume += item.volume || 0
                        total[item.region].value += item.value || 0
                    }
                })
                return total
            })

            const formatNum = (num) => {
                if(!num) return '-'
                return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 })
            }

            onMounted(() => {
                fetchData()
            })

            return { groupedData, grandTotal, formatNum, currentDate }
        }
    }).mount('#app')
</script>
</body>
</html>
